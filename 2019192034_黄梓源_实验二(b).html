<html>

<head>
  <title>2019192034_黄梓源_实验二(b)</title>
  <style>
    body {
      font-family: Helvetica, Arial, sans-serif
    }

    h1 {
      background-color: steelblue;
      color: white;
      padding: 5pt;
    }

    h2 {
      color: gray;
    }

    svg {
      border-style: solid;
      border-color: grey;
      border-width: 2pt;
    }

    .mainView {
      display: flex;
    }
  </style>
</head>

<body>
  <h1>Global Sales</h1>
  <div class="mainView">
    <div>
      <h2>Categories</h2>
      <svg id="CatergoryChart">
        <g id="rects"></g>
        <g id="xAxis"></g>
        <g id="yAxis"></g>
      </svg>
    </div>
    <div>
      <h2>Areas</h2>
      <svg id="Map"></svg>
    </div>
    <div>
      <h2>Other</h2>
      <svg id="Other"></svg>
    </div>
  </div>

  <script src="d3/d3.min.js"></script>
  <script>
    var barData;

    // 尺寸
    var barChartWidth = 480;
    var barChartHeight = 480;
    var barChartPadding = { top: 30, left: 80, bottom: 30, right: 30 };

    // 绑定
    var barChart = d3.select("#CatergoryChart")
      .attr("width", barChartWidth)
      .attr("height", barChartHeight);

    var barData = [];   //强制要求是array类型，方便后面调用push函数
    var nestBySubCategory;

    d3.csv("data/sub-categories-states-sales.csv").then(function (data) {
      var dataUS = data.filter(function (d) {
        return d.country == "United States";
      });
      // 转换为数值类型
      dataUS.forEach((item, i) => {
        item.profit = +item.profit;
        item.sales = +item.sales;
      });
      // 按类别重新组织数据
      nestBySubCategory = d3.groups(dataUS, function (d) {  //使用groups形成一个二维数组，二维数组上进行数据操作，注意与group的区别，group形成MAP数据
        return d.subCategory;
      });
      console.log(nestBySubCategory);
    });

    nestBySubCategory.forEach(function (item, index, array) { //第一层循环,读取0-16个数组a
      var sumProfit = 0;
      var sumSales = 0;
      item[1].forEach(function (d) {      //第二层循环，对数值累加
        sumProfit += d.profit;
        sumSales += d.sales;
      })
      barData.push({            //将加过的结果放入bardata中
        subCategory: item[0],
        profit: sumProfit,
        sales: sumSales
      });
    })
    console.log(barData);

    // 转换为映射表形式，方便后续快速检索指定类别
    nestBySubCategory = d3.group(dataUS, d => d.subCategory)
    console.log(nestBySubCategory);    //注意groups和group的区别
    drawBarChart(); // 根据barData来绘制柱状图

    // drawBarChart() 绘制
    function drawBarChart() {
      var maxSales = d3.max(barData, function (d) {
        return d.sales;
      });
      var xScale = d3.scaleLinear()
        .domain([0, maxSales])
        .range([barChartPadding.left, barChartWidth - barChartPadding.right]);

      var yScale = d3.scaleBand()
        .domain(barData.map(function (d) {
          return d.subCategory;
        }))
        .rangeRound([barChartPadding.top, barChartHeight - barChartPadding.bottom])
        .paddingInner(0.3);

      var maxProfit = d3.max(barData, function (d) {
        return d.profit;
      });

      var color = d3.scaleDiverging()
        .domain([-maxProfit, 0, maxProfit])
        .interpolator(d3.interpolateRdBu);

      var bindings = d3.select("#CatergoryChart").select("#rects").selectAll("rect")
        .data(barData);
      var updateRects = bindings;
      var enterRects = bindings.enter();
      var exitRects = bindings.exit();

      enterRects.append("rect")
        .attr("height", yScale.bandwidth())
        .attr("width", function (d, i) {
          return xScale(d.sales) - xScale(0);
        })
        .attr("y", function (d, i) {
          return yScale(d.subCategory);
        })
        .attr("x", function (d, i) {
          return xScale(0);
        })
        .style("fill", function (d, i) {
          return color(d.profit);
        });

      // 绘制X坐标轴
      var xAxis = d3.axisBottom(xScale).ticks(3);
      d3.select("#xAxis").call(xAxis)
        .attr("transform", "translate(0," + yScale.range()[1] + ")");
      // 绘制Y坐标轴
      var yAxis = d3.axisLeft(yScale);
      d3.select("#yAxis").call(yAxis)
        .attr("transform", "translate(" + xScale.range()[0] + ",0)");
    }
  </script>
</body>

</html>